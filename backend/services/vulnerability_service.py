"""Vulnerability management service."""
from typing import Optional, List, Dict, Any
from datetime import datetime

from core.database import DatabaseManager
from core.models import Vulnerability, User
from core.schemas import VulnerabilityResponse, VulnerabilityUpdate, VulnerabilitySeverity, VulnerabilityStatus, PaginationParams
from core.logging import get_logger, audit_logger

logger = get_logger(__name__)


class VulnerabilityService:
    """Service for vulnerability management operations."""
    
    def get_vulnerability_by_id(self, vuln_id: int, user_id: int) -> Optional[VulnerabilityResponse]:
        """Get vulnerability by ID with permission check."""
        with DatabaseManager() as db:
            from repositories.vulnerability_repository import VulnerabilityRepository
            vuln_repo = VulnerabilityRepository(db)
            
            vuln = vuln_repo.get_by_id(vuln_id)
            if not vuln:
                return None
            
            # Check permissions - user can access vulnerabilities they reported or are assigned to
            if vuln.reported_by != user_id and vuln.assigned_to != user_id:
                # Admins can access all vulnerabilities - need to check user role
                user = db.query(User).filter(User.id == user_id).first()
                if not user or user.role != "admin":
                    return None
            
            return VulnerabilityResponse(
                id=vuln.id,
                scan_id=vuln.scan_id,
                target=vuln.target,
                type=vuln.type,
                severity=vuln.severity,
                title=vuln.title,
                description=vuln.description,
                payload=vuln.payload,
                request=vuln.request,
                response=vuln.response,
                cvss_score=vuln.cvss_score,
                cve_id=vuln.cve_id,
                status=vuln.status,
                created_at=vuln.created_at,
                updated_at=vuln.updated_at,
                reported_by=vuln.reported_by,
                assigned_to=vuln.assigned_to
            )
    
    def get_user_vulnerabilities(
        self,
        user_id: int,
        page: int = 1,
        per_page: int = 20,
        severity: Optional[VulnerabilitySeverity] = None,
        status: Optional[VulnerabilityStatus] = None,
        vuln_type: Optional[str] = None
    ) -> List[VulnerabilityResponse]:
        """Get vulnerabilities for a user."""
        pagination = PaginationParams(page=page, per_page=per_page)
        
        with DatabaseManager() as db:
            from repositories.vulnerability_repository import VulnerabilityRepository
            vuln_repo = VulnerabilityRepository(db)
            
            # Check if user is admin
            user = db.query(User).filter(User.id == user_id).first()
            is_admin = user and user.role == "admin"
            
            if is_admin:
                # Admins can see all vulnerabilities
                vulns = vuln_repo.get_all_vulnerabilities(pagination, severity, status, vuln_type)
            else:
                # Regular users can only see their own vulnerabilities
                vulns = vuln_repo.get_user_vulnerabilities(user_id, pagination, severity, status, vuln_type)
            
            return [
                VulnerabilityResponse(
                    id=vuln.id,
                    scan_id=vuln.scan_id,
                    target=vuln.target,
                    type=vuln.type,
                    severity=vuln.severity,
                    title=vuln.title,
                    description=vuln.description,
                    payload=vuln.payload,
                    request=vuln.request,
                    response=vuln.response,
                    cvss_score=vuln.cvss_score,
                    cve_id=vuln.cve_id,
                    status=vuln.status,
                    created_at=vuln.created_at,
                    updated_at=vuln.updated_at,
                    reported_by=vuln.reported_by,
                    assigned_to=vuln.assigned_to
                ) for vuln in vulns
            ]
    
    def update_vulnerability(self, vuln_id: int, user_id: int, update_data: Dict[str, Any]) -> Optional[VulnerabilityResponse]:
        """Update vulnerability with permission check."""
        with DatabaseManager() as db:
            from repositories.vulnerability_repository import VulnerabilityRepository
            vuln_repo = VulnerabilityRepository(db)
            
            vuln = vuln_repo.get_by_id(vuln_id)
            if not vuln:
                return None
            
            # Check permissions
            user = db.query(User).filter(User.id == user_id).first()
            is_admin = user and user.role == "admin"
            can_modify = (vuln.reported_by == user_id or vuln.assigned_to == user_id or is_admin)
            
            if not can_modify:
                return None
            
            # Update vulnerability
            updated_vuln = vuln_repo.update(vuln_id, update_data)
            
            return VulnerabilityResponse(
                id=updated_vuln.id,
                scan_id=updated_vuln.scan_id,
                target=updated_vuln.target,
                type=updated_vuln.type,
                severity=updated_vuln.severity,
                title=updated_vuln.title,
                description=updated_vuln.description,
                payload=updated_vuln.payload,
                request=updated_vuln.request,
                response=updated_vuln.response,
                cvss_score=updated_vuln.cvss_score,
                cve_id=updated_vuln.cve_id,
                status=updated_vuln.status,
                created_at=updated_vuln.created_at,
                updated_at=updated_vuln.updated_at,
                reported_by=updated_vuln.reported_by,
                assigned_to=updated_vuln.assigned_to
            )
    
    def assign_vulnerability(self, vuln_id: int, user_id: int, assigned_to: int) -> bool:
        """Assign vulnerability to a user."""
        with DatabaseManager() as db:
            from repositories.vulnerability_repository import VulnerabilityRepository
            vuln_repo = VulnerabilityRepository(db)
            
            vuln = vuln_repo.get_by_id(vuln_id)
            if not vuln:
                return False
            
            # Check permissions
            user = db.query(User).filter(User.id == user_id).first()
            is_admin = user and user.role == "admin"
            can_assign = (vuln.reported_by == user_id or vuln.assigned_to == user_id or is_admin)
            
            if not can_assign:
                return False
            
            # Check if target user exists
            target_user = db.query(User).filter(User.id == assigned_to).first()
            if not target_user:
                return False
            
            vuln_repo.assign_to_user(vuln_id, assigned_to)
            return True
    
    def change_vulnerability_status(self, vuln_id: int, user_id: int, status: VulnerabilityStatus) -> bool:
        """Change vulnerability status."""
        with DatabaseManager() as db:
            from repositories.vulnerability_repository import VulnerabilityRepository
            vuln_repo = VulnerabilityRepository(db)
            
            vuln = vuln_repo.get_by_id(vuln_id)
            if not vuln:
                return False
            
            # Check permissions
            user = db.query(User).filter(User.id == user_id).first()
            is_admin = user and user.role == "admin"
            can_modify = (vuln.reported_by == user_id or vuln.assigned_to == user_id or is_admin)
            
            if not can_modify:
                return False
            
            vuln_repo.change_status(vuln_id, status)
            return True
    
    def get_vulnerability_statistics(self, user_id: int) -> Dict[str, Any]:
        """Get vulnerability statistics for user."""
        with DatabaseManager() as db:
            from repositories.vulnerability_repository import VulnerabilityRepository
            vuln_repo = VulnerabilityRepository(db)
            
            # Check if user is admin
            user = db.query(User).filter(User.id == user_id).first()
            is_admin = user and user.role == "admin"
            
            return vuln_repo.get_vulnerability_statistics(user_id if not is_admin else None)
    
    def get_critical_vulnerabilities(self, user_id: int) -> List[VulnerabilityResponse]:
        """Get critical vulnerabilities."""
        with DatabaseManager() as db:
            from repositories.vulnerability_repository import VulnerabilityRepository
            vuln_repo = VulnerabilityRepository(db)
            
            # Check if user is admin
            user = db.query(User).filter(User.id == user_id).first()
            is_admin = user and user.role == "admin"
            
            vulns = vuln_repo.get_critical_vulnerabilities()
            
            # Filter for user if not admin
            if not is_admin:
                vulns = [vuln for vuln in vulns if vuln.reported_by == user_id or vuln.assigned_to == user_id]
            
            return [
                VulnerabilityResponse(
                    id=vuln.id,
                    scan_id=vuln.scan_id,
                    target=vuln.target,
                    type=vuln.type,
                    severity=vuln.severity,
                    title=vuln.title,
                    description=vuln.description,
                    payload=vuln.payload,
                    request=vuln.request,
                    response=vuln.response,
                    cvss_score=vuln.cvss_score,
                    cve_id=vuln.cve_id,
                    status=vuln.status,
                    created_at=vuln.created_at,
                    updated_at=vuln.updated_at,
                    reported_by=vuln.reported_by,
                    assigned_to=vuln.assigned_to
                ) for vuln in vulns
            ]
    
    def get_unassigned_vulnerabilities(self, user_id: int) -> List[VulnerabilityResponse]:
        """Get unassigned vulnerabilities."""
        with DatabaseManager() as db:
            from repositories.vulnerability_repository import VulnerabilityRepository
            vuln_repo = VulnerabilityRepository(db)
            
            # Check if user is admin
            user = db.query(User).filter(User.id == user_id).first()
            is_admin = user and user.role == "admin"
            
            vulns = vuln_repo.get_unassigned_vulnerabilities()
            
            # Filter for user if not admin - show unassigned they can access
            if not is_admin:
                vulns = [vuln for vuln in vulns if vuln.reported_by == user_id]
            
            return [
                VulnerabilityResponse(
                    id=vuln.id,
                    scan_id=vuln.scan_id,
                    target=vuln.target,
                    type=vuln.type,
                    severity=vuln.severity,
                    title=vuln.title,
                    description=vuln.description,
                    payload=vuln.payload,
                    request=vuln.request,
                    response=vuln.response,
                    cvss_score=vuln.cvss_score,
                    cve_id=vuln.cve_id,
                    status=vuln.status,
                    created_at=vuln.created_at,
                    updated_at=vuln.updated_at,
                    reported_by=vuln.reported_by,
                    assigned_to=vuln.assigned_to
                ) for vuln in vulns
            ]
    
    def search_vulnerabilities(self, query: str, user_id: int, page: int = 1, per_page: int = 20) -> List[VulnerabilityResponse]:
        """Search vulnerabilities."""
        pagination = PaginationParams(page=page, per_page=per_page)
        
        with DatabaseManager() as db:
            from repositories.vulnerability_repository import VulnerabilityRepository
            vuln_repo = VulnerabilityRepository(db)
            
            # Check if user is admin
            user = db.query(User).filter(User.id == user_id).first()
            is_admin = user and user.role == "admin"
            
            vulns = vuln_repo.search(query, pagination)
            
            # Filter for user if not admin
            if not is_admin:
                vulns = [vuln for vuln in vulns if vuln.reported_by == user_id or vuln.assigned_to == user_id]
            
            return [
                VulnerabilityResponse(
                    id=vuln.id,
                    scan_id=vuln.scan_id,
                    target=vuln.target,
                    type=vuln.type,
                    severity=vuln.severity,
                    title=vuln.title,
                    description=vuln.description,
                    payload=vuln.payload,
                    request=vuln.request,
                    response=vuln.response,
                    cvss_score=vuln.cvss_score,
                    cve_id=vuln.cve_id,
                    status=vuln.status,
                    created_at=vuln.created_at,
                    updated_at=vuln.updated_at,
                    reported_by=vuln.reported_by,
                    assigned_to=vuln.assigned_to
                ) for vuln in vulns
            ]
